# aes_generate_malicious_firmware.py

import argparse
from pathlib import Path

from aes_utils import aes128_encrypt_file


def generate_aes_malicious_firmware(
    clean_dir: str,
    malicious_dir: str,
    password: str,
    suffix: str = "_aes",
):
    """
    Take all .bin files from clean_dir, encrypt them with AES-128,
    and write to malicious_dir, preserving base names.

    Example:
        clean/fw1.bin  -> malicious/fw1_aes.bin
    """
    clean_path = Path(clean_dir)
    malicious_path = Path(malicious_dir)

    if not clean_path.is_dir():
        raise FileNotFoundError(f"Clean firmware dir not found: {clean_path}")

    malicious_path.mkdir(parents=True, exist_ok=True)

    bin_files = list(clean_path.glob("*.bin"))
    if not bin_files:
        print(f"[!] No .bin files found in {clean_path}")
        return

    print(f"[+] Found {len(bin_files)} clean firmware files.")

    for fw in bin_files:
        out_name = fw.stem + suffix + fw.suffix  # e.g., fw1_aes.bin
        out_path = malicious_path / out_name

        print(f"[+] Encrypting {fw.name} -> {out_name}")
        aes128_encrypt_file(
            input_path=str(fw),
            output_path=str(out_path),
            password=password,
        )

    print("[+] Finished generating AES-128 'malicious' firmware files.")


def main():
    parser = argparse.ArgumentParser(
        description="Generate AES-128-encrypted malicious firmware from clean firmware."
    )
    parser.add_argument(
        "--clean_dir",
        type=str,
        default="data/firmware/clean",
        help="Directory with clean .bin firmware files",
    )
    parser.add_argument(
        "--malicious_dir",
        type=str,
        default="data/firmware/malicious",
        help="Output directory for AES-encrypted firmware",
    )
    parser.add_argument(
        "--password",
        type=str,
        required=True,
        help="Password used to derive AES-128 key",
    )
    parser.add_argument(
        "--suffix",
        type=str,
        default="_aes",
        help="Suffix to add to output filenames before .bin",
    )

    args = parser.parse_args()

    generate_aes_malicious_firmware(
        clean_dir=args.clean_dir,
        malicious_dir=args.malicious_dir,
        password=args.password,
        suffix=args.suffix,
    )


if __name__ == "__main__":
    main()
